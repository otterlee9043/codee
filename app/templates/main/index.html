<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=deivce-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">

  <script src="https://kit.fontawesome.com/16fd5c8b77.js" crossorigin="anonymous"></script>
  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.js"></script>

  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/github.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/languages/go.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300&display=swap" rel="stylesheet">
    <!-- jsTree -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
  <script>hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
  <title>Codee</title>
</head>
<header>
  <div class="topbar darkbg">
    <div class="logo-wrapper"><img src="{{url_for('static', filename='/logo_white.svg')}}" class="small-logo" alt=""
        srcset=""></div>

    <div class="logout2 white">
      <span>{{current_user.username}} 님,</span>
      <a href="{{ url_for('auth.logout') }}">logout</a>
    </div>
  </div>
</header>

<body>
  <div class="container center-col">
    {% if filename is not none %}
    {% if data is none %}
    <div class="full">
      <div class="topbar align-center">
        <h2 id="cd">{{filename}}</h2>
        <div class="buttonbar">
          <button type="button" class="button" onclick="copyToClip(document.getElementById('code'))">export</button>
          {%if username == current_user.username %}
          <button class="button clone-btn" type="button" onclick="saveCodee('{{ username }}')">save</button>
          {% endif %}
        </div>
      </div>
    </div>

    {% else %}
    <div class="full margin20">
      <span>{{ repo_name }}</span>
      <button type="button" class="button right" onclick="copyToClip(document.getElementById('code'))">export</button>
    </div>
    {% endif %}
    {% else %}
    <br>
    {% endif %}

    </h3>
    <div class="center-row full">
      <div class="sidebar col">
        <div class="filelist border-box scroll">
          <div id="tree"></div>
        </div>
        {%if username == current_user.username %}
        <div class="topbar margin10">

          <button class="button width48" type="button" onclick="pull('{{ username }}')">pull</button>
          <button class="button width48" type="button" onclick="push('{{ username }}')">push</button>

          <!-- <button class="button" type="button" class="modalButton" data-popup="popupOne"
                  onclick="createCodeeFile('codee','/home/codination/ver1/app/static/files/user2/OSSLab_0420_test')">
                  create codee</button> -->
        </div>

        <div class="full">
          <button class="button modalButton full" data-popup="popupOne">create codee</button>
        </div>
        {% endif %}
        <section class="modal modalWindow" id="popupOne">
          <section class="modalWrapper">
            <div>
              <form action="http://siskin21.cafe24.com/codination/ver1/create_codee" method="post">
                <div>
                  <div class="col-25">
                    <label for="name">codee name</label>
                  </div>
                  <div class="col-60">
                    <input id="codee_name" type="text" name="codee_name">
                  </div>
                  <div class="col-15">
                    <span>.cd</span>
                  </div>
                </div>
                <div>
                  <div class="col-25"><label for="codee_path">codee path</label></div>
                  <div class="col-60">
                    <input id='browse1_path' type="text" name='browse1_path' disabled="true">
                    <div id="drawer1" class="browse-dir scroll">
                      <ul id="dir_tree" aria-labelledby="tree_label">
                        <li id="browse1" class="dir"></li>
                      </ul>
                    </div>
                  </div>
                  <div class="col-15"> <button class='browse-btn' type='button'
                      onclick="open_dir('drawer1')">browse</button>
                  </div>

                </div>
                <div>
                  <div class="col-25"><label for="ref_filename">reference file name</label></div>
                  <div class="col-60">
                    <input id='browse2_path' name='browse2_path' type="text" disabled="true">
                    <div id="drawer2" class="browse-dir scroll">
                      <ul id="dir_tree" aria-labelledby="tree_label">
                        <li id="browse2" class="dir"></li>
                      </ul>
                    </div>
                  </div>
                  <div class="col-15"><button class='browse-btn' type='button'
                      onclick="open_dir('drawer2')">browse</button>
                  </div>
                </div>
                <div class="create-btn"><button onclick="createCodee()">Create</button>
                </div>
              </form>

            </div>


          </section>
          <a class="closeBtn">×</a>
        </section>
        <section class="modal overlay">
        </section>
      </div>
      {% if filename is none %}
      <div class="box" id='export'>
        <div class="center-col">
          <img src="{{url_for('static', filename='/6579900.jpg')}}" class="image" alt="" srcset="">
          <a class="image-src" href="http://www.freepik.com">Designed by Freepik</a>
        </div>
      </div>
      {% elif data is none %}
      <div class="box" id='export'>
        <div class="border-box">
          <div class="filename-bar" id="filename">{{ref_filename}}</div>
          <pre id="pre" class="context-menu-one">
                <code id="code">{{ref_data}}</code>
              </pre>
        </div>
      </div>

      {% else %}
      <div class="box" id='export'>
        <div class="border-box">
          <div class="filename-bar" id="filename">{{filename}}</div>
          <pre id="pre" class="">
                    <code id="code" >{{data}}</code>
                  </pre>
        </div>
      </div>
      {% endif %}

    </div>


  </div>

</body>
<script>

function drawDirectoryTree(data){
      $("#tree").jstree({
      plugins : [ "wholerow" ],
      core: {
        themes: {
          responsive: false,
        },
      },
      types: {
        default: {
          icon: "fa fa-folder",
        },
        file: {
          icon: "fa fa-file",
        },
      },
      plugins: ["types"],
      core: {
        data: data
      }
    }
    );
    }

  let jsonData = null;
  let clicks = 0;
  let timeout;

  $('#tree').on("changed.jstree", function (e, data) {
    clicks++;

    console.log(data);
    console.log("clicked: ", clicks);
    
    const target = data.node;

    if (data.action !== "deselect_all" && target.original.type === "dir" && target.a_attr.hasBeenOpened === false ){
      if (clicks === 1) {
        timeout = setTimeout(function() {
          const path = target.a_attr.path;
      fetch(`/api/repo/contents/${path}`)
        .then(function (response) {
          if (response.status != 200) {
            console.log(`Looks like there was a problem. Status code: ${response.status}`);
            return;
          }
          response.json().then(function(data){
            
            for(let i = 0; i < jsonData.length; i++){
              if (jsonData[i]['a_attr']['path'] === path){
                console.log(jsonData[i]);
                jsonData[i]['a_attr']['hasBeenOpened'] = true;
                jsonData[i]['state'] = {'opened': true};
              }
            }
            jsonData = [...jsonData, ...data];
            console.log(jsonData);
            // drawDirectoryTree(newJsonData);
            $('#tree').jstree(true).settings.core.data = jsonData;
            $('#tree').jstree(true).refresh();
            
          });
          
        })
        .catch(function (error) {
          console.log("Fetch error: " + error);
        });
          clicks = 0;
        }, 250);
      } else {
        clearTimeout(timeout);
        // double click event
        clicks = 0;
      }

      
      }
  });

  $(function () {
    jsonData = JSON.parse({{ tree|tojson }});
    console.log(jsonData);
    drawDirectoryTree(jsonData);
  }
  
  
  
  );

  settings = {
    //Model Popup
    objModalPopupBtn: ".modalButton",
    objModalCloseBtn: ".overlay, .closeBtn",
    objModalDataAttr: "data-popup"
  }
  $(settings.objModalPopupBtn).bind("click", function () {
    if ($(this).attr(settings.objModalDataAttr)) {
      var strDataPopupName = $(this).attr(settings.objModalDataAttr);
      //Fade In Modal Pop Up
      $(".overlay, #" + strDataPopupName).fadeIn();

    }
  });

  //On clicking the modal background
  $(settings.objModalCloseBtn).bind("click", function () {
    $(".modal").fadeOut();
  });

  </script>
<script src="{{ url_for('static', filename = 'script/import/html-to-rtf-browser.min.js') }}"></script>
<script src="{{ url_for('static', filename = 'script/index.js') }}"></script>

</html>