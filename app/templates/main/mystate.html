{% extends "darkbase.html" %}
{% block navbar %}
<div class="top">
    <a id='back' class="material-icons left-icons" href="{{ url_for('main.classroom', room_id = room_id) }}">
        arrow_back
    </a>
    <div class='right-icons'>
        <a class="material-icons icons" href="{{ url_for('main.classroom', room_id = room_id) }}">
            groups
        </a>
        <a id='back' class="material-icons icons" href="{{ url_for('main.chatroom', room_id = room_id) }}">
            question_answer
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class='my_state'>
    <div class='circle mine' style='background:{{ color }};'>
        <div class='mine emoji'></div>
    </div>
</div>

<div class='emoji_list'>
    <div class='circle' id='c1' style='background: #FF4D00;' onclick="changeColor('#FF4D00')"></div>
    <div class='circle' id='c2' style='background: #FF7F00;' onclick="changeColor('#FF7F00')"></div>
    <div class='circle' id='c3' style='background: #FAFF00;' onclick="changeColor('#FAFF00')"></div>
    <div class='circle' id='c4' style='background: #21C732;' onclick="changeColor('#21C732')"></div>
    <div class='circle' id='c5' style='background: #0094FF;' onclick="changeColor('#0094FF')"></div>
    <div class='emoji' id='e1' onclick="changeEmoji('&#128546')">&#128546</div>
    <div class='emoji' id='e2' onclick="changeEmoji('&#129300', 1)">&#129300</div>
    <div class='emoji' id='e3' onclick="changeEmoji('&#128559')">&#128559</div>
    <div class='emoji' id='e4' onclick="changeEmoji('&#128578')">&#128578</div>
    <div class='emoji' id='e5' onclick="changeEmoji('&#128512')">&#128512</div>
</div>

<script>

$(function(){
    validNavigation = false;
    //Attach the event keypress to exclude the F5 refresh (includes normal refresh)
    $(document).bind('keypress', function (e) {
        if (e.keyCode == 116) {
            validNavigation = true;
        }
    });

    // Attach the event click for all links in the page
    $("a").bind("click", function () {
        validNavigation = true;
    });

    // Attach the event submit for all forms in the page
    $("form").bind("submit", function () {
        validNavigation = true;
    });

    // Attach the event click for all inputs in the page
    $("input[type=submit]").bind("click", function () {
        validNavigation = true;
    });

    window.onbeforeunload = function () {
        if (!validNavigation) {
            return "Do you really want to close?"; 
        }
        validNavigation = false;
    };

});

    var clear_time = null;
    var state = JSON.parse('{{ state | safe }}');
    var cur_color = state.color;
    var cur_emoji = state.emoji;
    console.log(cur_color);
    document.getElementsByClassName("circle mine")[0].style.background = cur_color;

    function changeColor(color) {
        document.getElementsByClassName("circle mine")[0].style.background = color;
        cur_color = color;

        var data = {
            color: color,
        }
        
        fetch(`${window.origin}/13thweek/my_state/{{room_id}}/set_color`, {
            method: "POST",
            credentials: "include",
            body: JSON.stringify(data),
            cache: "no-cache",
            headers: new Headers({
                "content-type": "application/json"
            })
        }).then(function (response) {
            if (response.status !== 200) {
                console.log(`Looks like there was a problem. Status code: ${response.status}`);
                return;
            }
            response.json().then(function (data) {
                console.log(`Good`);
            });
        })
            .catch(function (error) {
                console.log("Fetch error: " + error);
            });

    }
    function changeEmoji(emoji, flag = 0) {
        if (flag) {
            document.getElementsByClassName("mine emoji")[0].innerHTML = "<span style='position: absolute; top: 14%; left: 8%;'>" + emoji + "</span>";
        }
        else {
            document.getElementsByClassName("mine emoji")[0].innerHTML = "<span style='position: absolute; top: 8.5%; left: 7.5%;'>" + emoji + "</span>";
        }

        clearTimeout(clear_time);
        clear_time = setTimeout(function () {
            function removeEmoji() {
                document.getElementsByClassName("mine emoji")[0].innerHTML = "";
            }
        }, 5000);

        cur_emoji = emoji;
        var data = {
            emoji: emoji,
        }
        fetch(`${window.origin}/13thweek/my_state/{{room_id}}/set_emoji`, {
            method: "POST",
            credentials: "include",
            body: JSON.stringify(data),
            cache: "no-cache",
            headers: new Headers({
                "content-type": "application/json"
            })
        }).then(function (response) {
            if (response.status !== 200) {
                console.log(`Looks like there was a problem. Status code: ${response.status}`);
                return;
            }
            response.json().then(function (data) {
                console.log(`Good`);
            });
        })
            .catch(function (error) {
                console.log("Fetch error: " + error);
            });

    }

</script>
{% endblock %}